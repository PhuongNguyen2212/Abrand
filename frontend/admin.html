<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Admin Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.22.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const API_URL = "https://api.giangkimhoan.com";
        const FALLBACK_IMAGE = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=";

        const formatVND = (number) => {
            if (!number && number !== 0) return "";
            return new Intl.NumberFormat("vi-VN", {
                style: "currency",
                currency: "VND",
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(Math.round(number)).replace(/\s/g, '');
        };

        const parseVND = (input) => {
            if (!input) return 0;
            const cleaned = input.toString().replace(/[^\d]/g, "");
            return parseFloat(cleaned) || 0;
        };

        function ProductManagement({ setError, setSuccess, isProcessing, setIsProcessing }) {
            const [products, setProducts] = useState([]);
            const [filteredProducts, setFilteredProducts] = useState([]);
            const [modalOpen, setModalOpen] = useState(false);
            const [editingProduct, setEditingProduct] = useState(null);
            const [newProduct, setNewProduct] = useState({
                name: "", brand: "", type: "", material: "", originalPrice: "", salePrice: "", description: ""
            });
            const [selectedFiles, setSelectedFiles] = useState([]);
            const [mainImageIndex, setMainImageIndex] = useState(0);
            const [keepImages, setKeepImages] = useState(true);
            const [excelFile, setExcelFile] = useState(null);
            const [searchQuery, setSearchQuery] = useState("");
            const [filterBrand, setFilterBrand] = useState("");
            const [filterType, setFilterType] = useState("");
            const [uploadProgress, setUploadProgress] = useState(0);
            const [uploadStatus, setUploadStatus] = useState("");
            const [existingImages, setExistingImages] = useState([]);

            const availableBrands = ["Cartier", "Bvlgari", "Van Cleef & Arpels", "Chrome Hearts", "GKH Jewelry"];
            const availableTypes = ["Ring", "Necklace", "Bracelet", "Collar", "Earring"];
            const availableMaterials = ["Vàng 10k", "Vàng 18k", "Bạc", "Bạch kim"];
            const MAX_IMAGES = 4;

            useEffect(() => {
                fetchProducts();
            }, []);

            useEffect(() => {
                const filtered = products.filter(product =>
                    (product.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                     product.description.toLowerCase().includes(searchQuery.toLowerCase())) &&
                    (filterBrand ? product.brand === filterBrand : true) &&
                    (filterType ? product.type === filterType : true)
                );
                setFilteredProducts(filtered);
            }, [products, searchQuery, filterBrand, filterType]);

            const fetchProducts = async () => {
                try {
                    const token = sessionStorage.getItem("token");
                    const response = await fetch(`${API_URL}/api/products`, {
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${token}`
                        },
                        mode: "cors",
                        cache: "no-cache"
                    });
                    if (!response.ok) throw new Error("Failed to fetch products");
                    const data = await response.json();
                    setProducts(data);
                } catch (err) {
                    setError(`Error fetching products: ${err.message}`);
                }
            };

            const handleSaveProduct = async (e) => {
                e.preventDefault();
                if (isProcessing) return;
                setIsProcessing(true);

                const { name, brand, type, material, originalPrice, salePrice, description } = newProduct;
                const parsedOriginalPrice = parseVND(originalPrice);
                const parsedSalePrice = salePrice ? parseVND(salePrice) : 0;
                const totalImages = (keepImages ? existingImages.length : 0) + selectedFiles.length;

                if (!name.trim()) {
                    setError("Product name is required");
                    setIsProcessing(false);
                    return;
                }
                if (!availableBrands.includes(brand)) {
                    setError("Invalid brand selected");
                    setIsProcessing(false);
                    return;
                }
                if (!availableTypes.includes(type)) {
                    setError("Invalid type selected");
                    setIsProcessing(false);
                    return;
                }
                if (!availableMaterials.includes(material)) {
                    setError("Invalid material selected");
                    setIsProcessing(false);
                    return;
                }
                if (isNaN(parsedOriginalPrice) || parsedOriginalPrice <= 0) {
                    setError("Original price must be a positive number");
                    setIsProcessing(false);
                    return;
                }
                if (salePrice && (isNaN(parsedSalePrice) || parsedSalePrice < 0)) {
                    setError("Sale price must be a non-negative number");
                    setIsProcessing(false);
                    return;
                }
                if (totalImages === 0) {
                    setError("At least one image is required");
                    setIsProcessing(false);
                    return;
                }
                if (totalImages > MAX_IMAGES) {
                    setError(`Total images cannot exceed ${MAX_IMAGES}`);
                    setIsProcessing(false);
                    return;
                }
                if (mainImageIndex >= totalImages) {
                    setError("Main image index is invalid");
                    setIsProcessing(false);
                    return;
                }

                const formData = new FormData();
                formData.append("name", name.trim());
                formData.append("brand", brand);
                formData.append("type", type);
                formData.append("material", material);
                formData.append("originalPrice", parsedOriginalPrice);
                formData.append("salePrice", parsedSalePrice);
                formData.append("description", description.trim());
                formData.append("mainImageIndex", mainImageIndex);
                selectedFiles.forEach((file, index) => {
                    formData.append(`images`, file);
                });
                if (editingProduct) {
                    formData.append("version", editingProduct.version || 0);
                    formData.append("keepImages", keepImages.toString());
                    existingImages.forEach((url, index) => {
                        formData.append(`existingImages[${index}]`, url);
                    });
                }

                try {
                    const token = sessionStorage.getItem("token");
                    const url = editingProduct ? `${API_URL}/api/products/${editingProduct.id}` : `${API_URL}/api/products`;
                    const method = editingProduct ? "PATCH" : "POST";

                    const response = await fetch(url, {
                        method,
                        headers: { Authorization: `Bearer ${token}` },
                        body: formData
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        if (response.status === 404) {
                            setError("Product not found");
                        } else if (response.status === 401) {
                            setError("Session expired. Please log in again.");
                            handleLogout();
                        } else if (response.status === 409) {
                            setError("Product was modified by another user. Please refresh and try again.");
                        } else {
                            setError(`Error saving product: ${errorData.message || "Unknown error"}`);
                        }
                        throw new Error(errorData.message);
                    }

                    await fetchProducts();
                    setModalOpen(false);
                    setNewProduct({ name: "", brand: "", type: "", material: "", originalPrice: "", salePrice: "", description: "" });
                    setSelectedFiles([]);
                    setMainImageIndex(0);
                    setKeepImages(true);
                    setEditingProduct(null);
                    setExistingImages([]);
                    setSuccess(editingProduct ? "Product updated successfully" : "Product added successfully");
                } catch (err) {
                    console.error("Error saving product:", err);
                } finally {
                    setIsProcessing(false);
                }
            };

            const handleExcelUpload = async (e) => {
                e.preventDefault();
                if (!excelFile || isProcessing) return;
                setIsProcessing(true);
                setUploadProgress(0);
                setUploadStatus("Uploading...");

                if (!/application\/vnd\.openxmlformats-officedocument\.spreadsheetml\.sheet|application\/vnd\.ms-excel/.test(excelFile.type)) {
                    setError("Please upload a valid Excel file (.xlsx, .xls)");
                    setExcelFile(null);
                    setUploadStatus("");
                    setIsProcessing(false);
                    return;
                }

                if (excelFile.size > 25 * 1024 * 1024) {
                    setError("File size exceeds 25MB limit. Try removing unnecessary rows/columns, saving as a compressed .xlsx format, or splitting the file into smaller parts.");
                    setExcelFile(null);
                    setUploadStatus("");
                    setIsProcessing(false);
                    return;
                }

                const formData = new FormData();
                formData.append("excel", excelFile);

                try {
                    const token = sessionStorage.getItem("token");
                    const xhr = new XMLHttpRequest();
                    xhr.open("POST", `${API_URL}/api/upload-excel`, true);
                    xhr.setRequestHeader("Authorization", `Bearer ${token}`);

                    xhr.upload.onprogress = (event) => {
                        if (event.lengthComputable) {
                            const percentComplete = Math.round((event.loaded / event.total) * 100);
                            setUploadProgress(percentComplete);
                        }
                    };

                    xhr.onload = async () => {
                        if (xhr.status === 201) {
                            setUploadStatus("Processing complete!");
                            await fetchProducts();
                            setExcelFile(null);
                            setSuccess("Excel file processed successfully");
                        } else {
                            const errorData = JSON.parse(xhr.responseText);
                            setUploadStatus("Upload failed");
                            setError(`Error uploading Excel: ${errorData.message || "Unknown error"} (Status: ${xhr.status})`);
                        }
                        setIsProcessing(false);
                    };

                    xhr.onerror = () => {
                        setUploadStatus("Upload failed");
                        setError("Error uploading Excel: Network error");
                        setIsProcessing(false);
                    };

                    xhr.send(formData);
                } catch (err) {
                    setUploadStatus("Upload failed");
                    setError(`Error uploading Excel: ${err.message}`);
                    setIsProcessing(false);
                }
            };

            const handleDeleteProduct = async (productId) => {
                if (isProcessing || !confirm(`Are you sure you want to delete product with ID ${productId}?`)) return;
                setIsProcessing(true);
                setError('');
                setSuccess('');

                try {
                    const token = sessionStorage.getItem('token');
                    if (!token) {
                        setError('Session expired. Please log in again.');
                        handleLogout();
                        return;
                    }

                    if (!productId || typeof productId !== 'string' || productId.trim() === '') {
                        setError('Invalid product ID');
                        return;
                    }

                    const response = await fetch(`${API_URL}/api/products/${encodeURIComponent(productId.trim())}`, {
                        method: 'DELETE',
                        headers: { Authorization: `Bearer ${token}` }
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        if (response.status === 401) {
                            setError('Session expired. Please log in again.');
                            handleLogout();
                        } else if (response.status === 404) {
                            setError(`Product with ID ${productId} not found. Please refresh the product list.`);
                        } else if (response.status === 400) {
                            setError(errorData.message || 'Invalid request. Check product ID.');
                        } else {
                            setError(errorData.message || 'Error deleting product');
                        }
                        throw new Error(errorData.message || 'Failed to delete product');
                    }

                    await fetchProducts();
                    setSuccess(`Product with ID ${productId} deleted successfully`);
                } catch (err) {
                    console.error('Error deleting product:', err.message);
                } finally {
                    setIsProcessing(false);
                }
            };

            const openEditModal = (product) => {
                setEditingProduct(product);
                setNewProduct({
                    name: product.name,
                    brand: product.brand,
                    type: product.type,
                    material: product.material,
                    originalPrice: formatVND(product.originalPrice),
                    salePrice: formatVND(product.salePrice),
                    description: product.description || ""
                });
                setSelectedFiles([]);
                setMainImageIndex(product.mainImageIndex || 0);
                setKeepImages(true);
                setExistingImages(product.imageUrls || []);
                setModalOpen(true);
            };

            const removeExistingImage = (index) => {
                const newImages = existingImages.filter((_, i) => i !== index);
                if (newImages.length === 0 && selectedFiles.length === 0) {
                    setError("At least one image is required");
                    return;
                }
                setExistingImages(newImages);
                if (mainImageIndex === index) {
                    setMainImageIndex(0);
                } else if (mainImageIndex > index) {
                    setMainImageIndex(mainImageIndex - 1);
                }
            };

            const removeSelectedFile = (index) => {
                const newFiles = selectedFiles.filter((_, i) => i !== index);
                const totalImages = (keepImages ? existingImages.length : 0) + newFiles.length;
                if (totalImages === 0) {
                    setError("At least one image is required");
                    return;
                }
                setSelectedFiles(newFiles);
                if (mainImageIndex >= existingImages.length && mainImageIndex - existingImages.length === index) {
                    setMainImageIndex(existingImages.length);
                }
            };

            return (
                <div className="container mx-auto p-6 max-w-7xl">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div className="bg-white p-6 rounded-lg shadow-lg">
                            <h3 className="text-xl font-semibold mb-4">Upload Excel</h3>
                            <form onSubmit={handleExcelUpload}>
                                <input
                                    type="file"
                                    accept=".xlsx,.xls"
                                    onChange={(e) => {
                                        setExcelFile(e.target.files[0]);
                                        setUploadStatus("");
                                        setUploadProgress(0);
                                    }}
                                    className="w-full p-2 border rounded-lg mb-4"
                                    disabled={isProcessing}
                                />
                                {uploadStatus && (
                                    <div className="mb-4">
                                        <p className="text-sm text-gray-600">{uploadStatus}</p>
                                        {uploadProgress > 0 && (
                                            <div className="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                                                <div
                                                    className="bg-blue-600 h-2.5 rounded-full"
                                                    style={{ width: `${uploadProgress}%` }}
                                                ></div>
                                            </div>
                                        )}
                                    </div>
                                )}
                                <button
                                    type="submit"
                                    className="w-full bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 disabled:bg-blue-300 transition"
                                    disabled={isProcessing || !excelFile}
                                >
                                    {isProcessing ? "Uploading..." : "Upload Excel"}
                                </button>
                            </form>
                        </div>

                        <div className="bg-white p-6 rounded-lg shadow-lg md:col-span-2">
                            <h3 className="text-xl font-semibold mb-4">Filters</h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input
                                    type="text"
                                    placeholder="Search by name or description..."
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    className="p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                                <select
                                    value={filterBrand}
                                    onChange={(e) => setFilterBrand(e.target.value)}
                                    className="p-2 border rounded-lg"
                                >
                                    <option value="">All Brands</option>
                                    {availableBrands.map(brand => (
                                        <option key={brand} value={brand}>{brand}</option>
                                    ))}
                                </select>
                                <select
                                    value={filterType}
                                    onChange={(e) => setFilterType(e.target.value)}
                                    className="p-2 border rounded-lg"
                                >
                                    <option value="">All Types</option>
                                    {availableTypes.map(type => (
                                        <option key={type} value={type}>{type}</option>
                                    ))}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-lg shadow-lg">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-semibold">Products</h3>
                            <button
                                onClick={() => {
                                    setEditingProduct(null);
                                    setNewProduct({ name: "", brand: "", type: "", material: "", originalPrice: "", salePrice: "", description: "" });
                                    setSelectedFiles([]);
                                    setMainImageIndex(0);
                                    setKeepImages(true);
                                    setExistingImages([]);
                                    setModalOpen(true);
                                }}
                                className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"
                            >
                                Add Product
                            </button>
                        </div>
                        <div className="overflow-x-auto max-h-[600px]">
                            <table className="w-full text-left">
                                <thead className="bg-gray-100 sticky top-0">
                                    <tr>
                                        <th className="p-3">ID</th>
                                        <th className="p-3">Images</th>
                                        <th className="p-3">Name</th>
                                        <th className="p-3">Description</th>
                                        <th className="p-3">Brand</th>
                                        <th className="p-3">Type</th>
                                        <th className="p-3">Material</th>
                                        <th className="p-3">Price</th>
                                        <th className="p-3">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredProducts.map((product, index) => (
                                        <tr key={product.id} className={`border-b ${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}`}>
                                            <td className="p-3">{product.id}</td>
                                            <td className="p-3">
                                                <div className="flex space-x-2">
                                                    {(product.imageUrls || []).map((url, i) => (
                                                        <img
                                                            key={i}
                                                            src={`${API_URL}${url}`}
                                                            alt={`Product ${i}`}
                                                            className={`w-12 h-12 object-cover rounded ${i === product.mainImageIndex ? 'border-2 border-blue-500' : ''}`}
                                                            onError={(e) => (e.target.src = FALLBACK_IMAGE)}
                                                        />
                                                    ))}
                                                </div>
                                            </td>
                                            <td className="p-3">{product.name}</td>
                                            <td className="p-3 max-w-xs truncate">{product.description || "No description"}</td>
                                            <td className="p-3">{product.brand}</td>
                                            <td className="p-3">{product.type}</td>
                                            <td className="p-3">{product.material}</td>
                                            <td className="p-3">{formatVND(product.salePrice || product.originalPrice)}</td>
                                            <td className="p-3 flex space-x-2">
                                                <button
                                                    onClick={() => openEditModal(product)}
                                                    className="bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition"
                                                    disabled={isProcessing}
                                                >
                                                    Edit
                                                </button>
                                                <button
                                                    onClick={() => handleDeleteProduct(product.id)}
                                                    className="bg-red-600 text-white px-3 py-1 rounded-lg hover:bg-red-700 transition"
                                                    disabled={isProcessing}
                                                >
                                                    Delete
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {modalOpen && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg flex flex-col max-h-[90vh]">
                                <h3 className="text-xl font-semibold mb-4">{editingProduct ? "Edit Product" : "Add Product"}</h3>
                                <form onSubmit={handleSaveProduct} className="space-y-4 flex-grow overflow-y-auto pr-2">
                                    <input
                                        type="text"
                                        placeholder="Product Name"
                                        value={newProduct.name}
                                        onChange={(e) => setNewProduct({ ...newProduct, name: e.target.value })}
                                        className="w-full p-2 border rounded-lg"
                                        required
                                    />
                                    <textarea
                                        placeholder="Product Description"
                                        value={newProduct.description}
                                        onChange={(e) => setNewProduct({ ...newProduct, description: e.target.value })}
                                        className="w-full p-2 border rounded-lg"
                                        rows="4"
                                    />
                                    <select
                                        value={newProduct.brand}
                                        onChange={(e) => setNewProduct({ ...newProduct, brand: e.target.value })}
                                        className="w-full p-2 border rounded-lg"
                                        required
                                    >
                                        <option value="">Select Brand</option>
                                        {availableBrands.map(brand => (
                                            <option key={brand} value={brand}>{brand}</option>
                                        ))}
                                    </select>
                                    <select
                                        value={newProduct.type}
                                        onChange={(e) => setNewProduct({ ...newProduct, type: e.target.value })}
                                        className="w-full p-2 border rounded-lg"
                                        required
                                    >
                                        <option value="">Select Type</option>
                                        {availableTypes.map(type => (
                                            <option key={type} value={type}>{type}</option>
                                        ))}
                                    </select>
                                    <select
                                        value={newProduct.material}
                                        onChange={(e) => setNewProduct({ ...newProduct, material: e.target.value })}
                                        className="w-full p-2 border rounded-lg"
                                        required
                                    >
                                        <option value="">Select Material</option>
                                        {availableMaterials.map(material => (
                                            <option key={material} value={material}>{material}</option>
                                        ))}
                                    </select>
                                    <input
                                        type="text"
                                        placeholder="Original Price (VND)"
                                        value={newProduct.originalPrice}
                                        onChange={(e) => setNewProduct({ ...newProduct, originalPrice: e.target.value })}
                                        className="w-full p-2 border rounded-lg"
                                        required
                                    />
                                    <input
                                        type="text"
                                        placeholder="Sale Price (VND)"
                                        value={newProduct.salePrice}
                                        onChange={(e) => setNewProduct({ ...newProduct, salePrice: e.target.value })}
                                        className="w-full p-2 border rounded-lg"
                                    />
                                    {editingProduct && (
                                        <div className="space-y-2">
                                            <label className="flex items-center">
                                                <input
                                                    type="checkbox"
                                                    checked={keepImages}
                                                    onChange={(e) => {
                                                        setKeepImages(e.target.checked);
                                                        if (e.target.checked) {
                                                            setExistingImages(editingProduct.imageUrls || []);
                                                        } else {
                                                            setExistingImages([]);
                                                        }
                                                    }}
                                                    className="mr-2"
                                                />
                                                Keep Existing Images
                                            </label>
                                            {(keepImages || existingImages.length > 0) && (
                                                <div className="flex flex-wrap gap-2">
                                                    {existingImages.map((url, index) => (
                                                        <div key={index} className="relative">
                                                            <img
                                                                src={`${API_URL}${url}`}
                                                                alt={`Product ${index}`}
                                                                className={`w-24 h-24 object-cover rounded ${index === mainImageIndex ? 'border-2 border-blue-500' : ''}`}
                                                                onError={(e) => (e.target.src = FALLBACK_IMAGE)}
                                                            />
                                                            <input
                                                                type="radio"
                                                                name="mainImage"
                                                                checked={index === mainImageIndex}
                                                                onChange={() => setMainImageIndex(index)}
                                                                className="absolute top-2 left-2"
                                                            />
                                                            <button
                                                                type="button"
                                                                onClick={() => removeExistingImage(index)}
                                                                className="absolute top-2 right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center"
                                                            >
                                                                X
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                    <div className="space-y-2">
                                        <input
                                            type="file"
                                            accept="image/jpeg,image/jpg,image/png"
                                            multiple
                                            onChange={(e) => {
                                                const remainingSlots = MAX_IMAGES - (keepImages ? existingImages.length : 0);
                                                const files = Array.from(e.target.files).slice(0, remainingSlots);
                                                setSelectedFiles(files);
                                                if (mainImageIndex >= existingImages.length) {
                                                    setMainImageIndex(existingImages.length);
                                                }
                                            }}
                                            className="w-full p-2 border rounded-lg"
                                            disabled={(keepImages ? existingImages.length : 0) >= MAX_IMAGES}
                                        />
                                        {((keepImages ? existingImages.length : 0) + selectedFiles.length > 0) && (
                                            <div className="flex flex-wrap gap-2">
                                                {selectedFiles.map((file, index) => (
                                                    <div key={index} className="relative">
                                                        <img
                                                            src={URL.createObjectURL(file)}
                                                            alt={`Preview ${index}`}
                                                            className={`w-24 h-24 object-cover rounded ${(index + existingImages.length) === mainImageIndex ? 'border-2 border-blue-500' : ''}`}
                                                        />
                                                        <input
                                                            type="radio"
                                                            name="mainImage"
                                                            checked={(index + existingImages.length) === mainImageIndex}
                                                            onChange={() => setMainImageIndex(index + existingImages.length)}
                                                            className="absolute top-2 left-2"
                                                        />
                                                        <button
                                                            type="button"
                                                            onClick={() => removeSelectedFile(index)}
                                                            className="absolute top-2 right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center"
                                                        >
                                                            X
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                    <div className="text-sm text-gray-600">
                                        Total images: {(keepImages ? existingImages.length : 0) + selectedFiles.length}/{MAX_IMAGES}
                                    </div>
                                </form>
                                <div className="flex justify-end space-x-2 mt-4">
                                    <button
                                        type="button"
                                        onClick={() => {
                                            setModalOpen(false);
                                            setKeepImages(true);
                                            setSelectedFiles([]);
                                            setMainImageIndex(0);
                                            setExistingImages([]);
                                        }}
                                        className="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        type="submit"
                                        onClick={handleSaveProduct}
                                        className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"
                                        disabled={isProcessing}
                                    >
                                        {isProcessing ? "Saving..." : "Save"}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function OrderManagement({ setError, setSuccess, isProcessing, setIsProcessing }) {
            const [carts, setCarts] = useState([]);
            const [filteredCarts, setFilteredCarts] = useState([]);
            const [products, setProducts] = useState([]);
            const [modalOpen, setModalOpen] = useState(false);
            const [editingCartItem, setEditingCartItem] = useState(null);
            const [newQuantity, setNewQuantity] = useState("");
            const [searchQuery, setSearchQuery] = useState("");

            useEffect(() => {
                fetchCarts();
                fetchProducts();
            }, []);

            useEffect(() => {
                const filtered = carts.flatMap(cart =>
                    cart.items.filter(item =>
                    (item.productId.toString().includes(searchQuery) ||
                        (products.find(p => p.id === item.productId)?.name.toLowerCase().includes(searchQuery.toLowerCase())))
                    ).map(item => ({ ...item, userId: cart.userId }))
                );
                setFilteredCarts(filtered);
            }, [carts, searchQuery, products]);

            const fetchCarts = async () => {
                try {
                    const token = sessionStorage.getItem("token");
                    const response = await fetch(`${API_URL}/api/cart`, {
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${token}`
                        },
                        mode: "cors",
                        cache: "no-cache"
                    });
                    if (!response.ok) throw new Error("Failed to fetch carts");
                    const data = await response.json();
                    setCarts(data);
                } catch (err) {
                    setError(`Error fetching orders: ${err.message}`);
                }
            };

            const fetchProducts = async () => {
                try {
                    const token = sessionStorage.getItem("token");
                    const response = await fetch(`${API_URL}/api/products`, {
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${token}`
                        },
                        mode: "cors",
                        cache: "no-cache"
                    });
                    if (!response.ok) throw new Error("Failed to fetch products");
                    const data = await response.json();
                    setProducts(data);
                } catch (err) {
                    setError(`Error fetching products: ${err.message}`);
                }
            };

            const handleUpdateCartItem = async (e) => {
                e.preventDefault();
                if (isProcessing) return;
                setIsProcessing(true);

                const parsedQuantity = parseInt(newQuantity);
                if (isNaN(parsedQuantity) || parsedQuantity < 1) {
                    setError("Invalid quantity");
                    setIsProcessing(false);
                    return;
                }

                try {
                    const token = sessionStorage.getItem("token");
                    const response = await fetch(`${API_URL}/api/cart`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            productId: editingCartItem.productId,
                            quantity: parsedQuantity - (editingCartItem.quantity || 0)
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || "Failed to update order");
                    }
                    await fetchCarts();
                    setModalOpen(false);
                    setEditingCartItem(null);
                    setNewQuantity("");
                    setSuccess("Order updated successfully");
                } catch (err) {
                    setError(`Error updating order: ${err.message}`);
                } finally {
                    setIsProcessing(false);
                }
            };

            const handleDeleteCartItem = async (userId, productId) => {
                if (isProcessing || !confirm("Are you sure you want to delete this order item?")) return;
                setIsProcessing(true);

                try {
                    const token = sessionStorage.getItem("token");
                    const response = await fetch(`${API_URL}/api/cart`, {
                        method: "DELETE",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${token}`
                        },
                        body: JSON.stringify({ productId })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || "Failed to delete order item");
                    }
                    await fetchCarts();
                    setSuccess("Order item deleted successfully");
                } catch (err) {
                    setError(`Error deleting order item: ${err.message}`);
                } finally {
                    setIsProcessing(false);
                }
            };

            const openEditModal = (item) => {
                setEditingCartItem(item);
                setNewQuantity(item.quantity.toString());
                setModalOpen(true);
            };

            return (
                <div className="container mx-auto p-6 max-w-7xl">
                    <div className="bg-white p-6 rounded-lg shadow-lg mb-8">
                        <h3 className="text-xl font-semibold mb-4">Filters</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input
                                type="text"
                                placeholder="Search by product ID or name..."
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                className="p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            />
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-lg shadow-lg">
                        <h3 className="text-xl font-semibold mb-4">Orders</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead className="bg-gray-100">
                                    <tr>
                                        <th className="p-3">User ID</th>
                                        <th className="p-3">Product Name</th>
                                        <th className="p-3">Quantity</th>
                                        <th className="p-3">Total Amount</th>
                                        <th className="p-3">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredCarts.map((item, index) => {
                                        const product = products.find(p => p.id === item.productId);
                                        const totalAmount = product ? (product.salePrice || product.originalPrice) * item.quantity : 0;
                                        return (
                                            <tr key={`${item.userId}-${item.productId}`} className={`border-b ${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}`}>
                                                <td className="p-3">{item.userId}</td>
                                                <td className="p-3">{product ? product.name : "Unknown Product"}</td>
                                                <td className="p-3">{item.quantity}</td>
                                                <td className="p-3">{formatVND(totalAmount)}</td>
                                                <td className="p-3 flex space-x-2">
                                                    <button
                                                        onClick={() => openEditModal(item)}
                                                        className="bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600 transition"
                                                        disabled={isProcessing}
                                                    >
                                                        Edit
                                                    </button>
                                                    <button
                                                        onClick={() => handleDeleteCartItem(item.userId, item.productId)}
                                                        className="bg-red-600 text-white px-3 py-1 rounded-lg hover:bg-red-700 transition"
                                                        disabled={isProcessing}
                                                    >
                                                        Delete
                                                    </button>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {modalOpen && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
                                <h3 className="text-xl font-semibold mb-4">Update Order Quantity</h3>
                                <form onSubmit={handleUpdateCartItem} className="space-y-4">
                                    <input
                                        type="number"
                                        placeholder="Quantity"
                                        value={newQuantity}
                                        onChange={(e) => setNewQuantity(e.target.value)}
                                        className="w-full p-2 border rounded-lg"
                                        min="1"
                                        required
                                    />
                                    <div className="flex justify-end space-x-2">
                                        <button
                                            type="button"
                                            onClick={() => setModalOpen(false)}
                                            className="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            type="submit"
                                            className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"
                                            disabled={isProcessing}
                                        >
                                            {isProcessing ? "Updating..." : "Update"}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function App() {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [username, setUsername] = useState("");
            const [password, setPassword] = useState("");
            const [error, setError] = useState("");
            const [success, setSuccess] = useState("");
            const [isProcessing, setIsProcessing] = useState(false);
            const [currentPage, setCurrentPage] = useState("products");

            useEffect(() => {
                if (success || error) {
                    const timer = setTimeout(() => {
                        setSuccess("");
                        setError("");
                    }, 5000);
                    return () => clearTimeout(timer);
                }
            }, [success, error]);

            useEffect(() => {
                const loggedIn = sessionStorage.getItem("isLoggedIn");
                if (loggedIn === "true" && sessionStorage.getItem("token")) {
                    setIsLoggedIn(true);
                }
            }, []);

            const handleLogin = async (e) => {
                e.preventDefault();
                try {
                    const response = await fetch(`${API_URL}/api/login`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await response.json();
                    if (data.success) {
                        setIsLoggedIn(true);
                        sessionStorage.setItem("isLoggedIn", "true");
                        sessionStorage.setItem("token", data.token);
                    } else {
                        setError(data.message || "Invalid credentials");
                    }
                } catch (err) {
                    setError(`Login failed: ${err.message}`);
                }
            };

            const handleLogout = () => {
                setIsLoggedIn(false);
                sessionStorage.clear();
                setUsername("");
                setPassword("");
                setCurrentPage("products");
            };

            if (!isLoggedIn) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gradient-to-r from-blue-500 to-purple-600">
                        <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
                            <h2 className="text-3xl font-bold text-gray-800 mb-6 text-center">Admin Login</h2>
                            {error && (
                                <div className="bg-red-100 text-red-700 p-4 rounded mb-4">{error}</div>
                            )}
                            <form onSubmit={handleLogin} className="space-y-4">
                                <input
                                    type="text"
                                    placeholder="Username"
                                    value={username}
                                    onChange={(e) => setUsername(e.target.value)}
                                    className="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                                <input
                                    type="password"
                                    placeholder="Password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                                <button
                                    type="submit"
                                    className="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition"
                                >
                                    Login
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen">
                    <nav className="bg-gray-800 text-white p-4">
                        <div className="container mx-auto flex justify-between items-center">
                            <h2 className="text-2xl font-bold">Admin Dashboard</h2>
                            <div className="flex space-x-4">
                                <button
                                    onClick={() => setCurrentPage("products")}
                                    className={`px-4 py-2 rounded-lg ${currentPage === "products" ? "bg-blue-600" : "bg-gray-600"} hover:bg-blue-700 transition`}
                                >
                                    Products
                                </button>
                                <button
                                    onClick={() => setCurrentPage("orders")}
                                    className={`px-4 py-2 rounded-lg ${currentPage === "orders" ? "bg-blue-600" : "bg-gray-600"} hover:bg-blue-700 transition`}
                                >
                                    Orders
                                </button>
                                <button
                                    onClick={handleLogout}
                                    className="bg-red-600 px-4 py-2 rounded-lg hover:bg-red-700 transition"
                                >
                                    Logout
                                </button>
                            </div>
                        </div>
                    </nav>
                    {(error || success) && (
                        <div className={`container mx-auto p-6 max-w-7xl ${error ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'} p-4 rounded-lg mb-6`}>
                            {error || success}
                        </div>
                    )}
                    {currentPage === "products" ? (
                        <ProductManagement
                            setError={setError}
                            setSuccess={setSuccess}
                            isProcessing={isProcessing}
                            setIsProcessing={setIsProcessing}
                        />
                    ) : (
                        <OrderManagement
                            setError={setError}
                            setSuccess={setSuccess}
                            isProcessing={isProcessing}
                            setIsProcessing={setIsProcessing}
                        />
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById("root"));
    </script>
</body>

</html>